# 采购计划管理系统 (PPOMS) 产品需求文档

| 文档属性 | 内容 |
| :--- | :--- |
| **文档编号** | PPOMS-PRD-001 |
| **当前版本** | V1.6.1365 |
| **状态** | 已发布 |
| **发布日期** | 2025-12-09 |
| **密级** | 内部公开 |
| **作者** | 蔡勒 (生产管理部) |

---

## 1. 文档控制

### 1.1 版本记录
| 版本号 | 日期 | 修改人 | 修改类型 | 修改描述 |
| :--- | :--- | :--- | :--- | :--- |
| V1.0.0 | 2025-11-01 | 蔡勒 | 新增 | 系统初始化，实现基础采购计划录入 |
| V1.2.0 | 2025-11-15 | 蔡勒 | 修改 | 增加自动编号与类别管理 |
| V1.5.0 | 2025-12-01 | 蔡勒 | 新增 | 增加月度计划、计划发放、数据管理模块 |
| V1.6.1365 | 2025-12-09 | 蔡勒 | 优化 | 优化打印导出样式（分组标题），完善校验逻辑 |

---

## 2. 目录
- [1. 文档控制](#1-文档控制)
- [2. 目录](#2-目录)
- [3. 产品概述](#3-产品概述)
    - [3.1 背景与目标](#31-背景与目标)
    - [3.2 总体架构](#32-总体架构)
    - [3.3 用户角色](#33-用户角色)
- [4. 功能需求 (Functional Requirements)](#4-功能需求-functional-requirements)
    - [4.1 工作台 (Workbench)](#41-工作台-workbench)
    - [4.2 月度计划 (Monthly Plan)](#42-月度计划-monthly-plan)
    - [4.3 采购计划管理 (Purchase Plan)](#43-采购计划管理-purchase-plan)
    - [4.4 计划发放 (Plan Release)](#44-计划发放-plan-release)
    - [4.5 计划导出与打印 (Export & Print)](#45-计划导出与打印-export--print)
    - [4.6 自动推荐 (Auto Recommendation)](#46-自动推荐-auto-recommendation)
    - [4.7 数据管理 (Data Manager)](#47-数据管理-data-manager)
- [5. 非功能需求 (Non-functional Requirements)](#5-非功能需求-non-functional-requirements)
- [6. 数据字典与数据库设计](#6-数据字典与数据库设计)
- [7. 附录](#7-附录)

---

## 3. 产品概述

### 3.1 背景与目标
**采购计划管理系统 (PPOMS)** 是一套专为生产管理部设计的轻量级桌面应用程序。旨在解决传统 Excel 管理模式下数据分散、版本混乱、统计滞后等痛点，实现从“月度预算”到“采购执行”的全流程闭环管理。

### 3.2 总体架构
系统基于 **Python 3.10+** 开发，采用 **MVC** 架构：
*   **前端**：PySide6 (Qt for Python) 构建原生桌面 UI。
*   **后端**：Python 业务逻辑层。
*   **数据**：SQLite 嵌入式数据库（单文件存储）。
*   **分发**：PyInstaller 打包为单文件 EXE。

### 3.3 用户角色
*   **计划员/管理员**：拥有所有模块权限，负责计划的制定、录入、发放、数据备份及基础设置维护。

---

## 4. 功能需求 (Functional Requirements)

### 4.1 工作台 (Workbench)

| ID | FR-WORK-001 |
| :--- | :--- |
| **需求名称** | 关键指标看板 |
| **优先级** | P1 |
| **需求描述** | 首页展示本月采购业务的核心统计数据，支持按月份筛选。 |
| **功能点** | 1. **总体指标**：显示本月计划总条数、总采购预算（万元）。<br>2. **进度指标**：显示待处理（未发放）、已处理计划数。<br>3. **分类统计**：分别展示民品、机加件、半成品的数量与金额。<br>4. **交互**：双击卡片跳转至对应功能模块。 |
| **验收标准** | 1. 切换月份筛选器，数据应实时刷新且准确无误。<br>2. 统计数据应与数据库实际记录完全一致。<br>3. 双击“待处理计划”卡片应跳转至“计划发放”页面。 |

### 4.2 月度计划 (Monthly Plan)

| ID | FR-MP-001 |
| :--- | :--- |
| **需求名称** | 月度预算管理与执行监控 |
| **优先级** | P0 |
| **需求描述** | 管理每月的宏观采购计划，并实时监控采购单的执行进度。 |
| **功能点** | 1. **增删改**：支持手动录入及Excel批量导入（包含标的、规格、预算、部门等）。<br>2. **默认值**：新增行时，需求部门默认填充“仓储中心”。<br>3. **执行统计**：点击刷新，系统自动匹配采购明细表，计算执行数量和金额。<br>4. **匹配逻辑**：`计划月份` + `标的名称(去空格)` + `规格型号(去空格)`。<br>5. **进度可视化**：通过进度条展示执行率（蓝色进行中，绿色已完成）。 |
| **验收标准** | 1. Excel导入功能能正确解析列名并入库。<br>2. 当采购计划录入新单据后，此处刷新应能看到执行数量增加。<br>3. 进度条颜色应随进度变化（100%变绿）。 |

### 4.3 采购计划管理 (Purchase Plan)

| ID | FR-PUR-001 |
| :--- | :--- |
| **需求名称** | 主单与明细管理 |
| **优先级** | P0 |
| **需求描述** | 核心业务模块，用于创建具体的采购申请单据。 |
| **功能点** | 1. **自动编号**：规则为 `CG-{YYMM}{类别代码}{4位流水}`。流水号按类别（MP/MPJ/MPB）独立计数。<br>2. **类别联动**：选择“半成品(MPB)”时，需求单位自动锁定为“仓储中心”。<br>3. **明细录入**：支持多行录入，包含采购标的、规格、数量、单价等15+字段。<br>4. **业务规则**：<br>&nbsp;&nbsp;- 选择“询比采购” -> 自动填“线下采购”<br>&nbsp;&nbsp;- 选择“公开招标/集中采购” -> 自动填“采购平台”<br>&nbsp;&nbsp;- 选择“框架协议” -> 自动填“能建商城” |
| **验收标准** | 1. 新建不同类别的单据，流水号应互不影响（如MP0001与MPB0001独立）。<br>2. 业务规则触发准确，无需人工干预。<br>3. 保存后数据不丢失，重启软件可查看。 |

| ID | FR-PUR-002 |
| :--- | :--- |
| **需求名称** | 序号校验工具 |
| **优先级** | P2 |
| **需求描述** | 检查当前单据的明细流水号（如 2601MP-1）是否连续且无重复。 |
| **验收标准** | 点击“工具-校验明细序号”，若存在断号或重号，应弹出警告提示具体号码。 |

### 4.4 计划发放 (Plan Release)

| ID | FR-REL-001 |
| :--- | :--- |
| **需求名称** | 计划审核与发放 |
| **优先级** | P1 |
| **需求描述** | 对已录入的计划进行分发处理，标记为“已发放”状态。 |
| **功能点** | 1. **待办列表**：自动聚合所有含“未发放”明细的主单。<br>2. **发放详情**：按“主单+采购员”维度展示待发放明细。<br>3. **状态流转**：点击“确认发放”后，更新数据库状态，且待办列表不再显示该条目。<br>4. **打印预览**：生成发放单打印视图。 |
| **验收标准** | 1. 确认发放后，工作台的“待处理计划”数量应减少。<br>2. 发放单打印预览应包含签字栏。 |

### 4.5 计划导出与打印 (Export & Print)

| ID | FR-EXP-001 |
| :--- | :--- |
| **需求名称** | 月度汇总导出与打印 |
| **优先级** | P1 |
| **需求描述** | 生成符合归档要求的月度汇总报表。 |
| **功能点** | 1. **数据加载**：按月份加载全量明细。<br>2. **Excel导出**：<br>&nbsp;&nbsp;- **排序**：半成品MPB -> 民品MP -> 机加件MPJ，同类下按明细号排序。<br>&nbsp;&nbsp;- **样式**：自动插入灰色/浅蓝背景的分组标题行（“半成品MPB”、“民品MP”），标题文字**左对齐**。<br>3. **打印输出**：<br>&nbsp;&nbsp;- 使用 QPainter 引擎绘制，支持分页。<br>&nbsp;&nbsp;- 打印样式需与Excel导出一致，包含分组标题行。<br>&nbsp;&nbsp;- 隐藏主单头部信息，仅显示月度大标题。 |
| **验收标准** | 1. 导出的Excel文件在WPS/Office中打开格式无乱码。<br>2. 分组标题行（灰色/浅蓝）位置正确，且文字靠左。<br>3. 打印预览中能看到同样的分组效果。 |

### 4.6 自动推荐 (Auto Recommendation)

| ID | FR-REC-001 |
| :--- | :--- |
| **需求名称** | 智能填充知识库 |
| **优先级** | P2 |
| **需求描述** | 根据历史数据或预设规则，自动填充表单字段。 |
| **功能点** | 1. **规则维护**：增删改查推荐规则（标的名称 -> 默认采购员/方式/途径/权重）。<br>2. **自动应用**：在采购计划明细录入时，输入标的名称后，自动匹配并填充相关字段。 |
| **验收标准** | 在推荐库中配置“A物品->张三”，在录入A物品时，计划发放人应自动变为“张三”。 |

### 4.7 数据管理 (Data Manager)

| ID | FR-DATA-001 |
| :--- | :--- |
| **需求名称** | 备份与恢复 |
| **优先级** | P0 |
| **需求描述** | 保障数据安全，防止意外丢失。 |
| **功能点** | 1. **立即备份**：一键备份当前数据库到本地 `backups/` 目录。<br>2. **导出备份**：另存为到指定路径。<br>3. **数据恢复**：支持从列表或文件恢复数据。<br>4. **安全机制**：恢复前强制自动创建临时备份。 |
| **验收标准** | 1. 点击备份后，文件夹中应出现新文件。<br>2. 恢复数据后，系统数据应回滚到备份时的状态。<br>3. 恢复操作前，应能看到系统自动生成的安全备份文件。 |

---

## 5. 非功能需求 (Non-functional Requirements)

1.  **性能**：
    *   启动时间 < 3秒。
    *   常规数据查询（<10000条）响应时间 < 100ms。
    *   支持 10万级 数据量的稳定运行。

2.  **兼容性**：
    *   操作系统：Windows 10 / 11 (64位)。
    *   显示分辨率：支持 1920x1080 及以上，适配 125% / 150% 缩放。

3.  **安全性**：
    *   数据存储在本地 SQLite 文件，无云端泄露风险。
    *   关键操作（删除、恢复）需二次确认。

4.  **易用性**：
    *   支持 Excel 文件的拖拽导入（预留接口）。
    *   所有表格支持行交替色显示，便于阅读。

---

## 6. 数据字典与数据库设计

### 6.1 核心表结构 (SQLite)

#### `orders` (主单表)
| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `number` | TEXT (PK) | 主单编号 (如 CG-2601MPB0001) |
| `yymm` | TEXT | 计划月份 (如 2601) |
| `category` | TEXT | 类别代码 (MP/MPJ/MPB) |
| `unit` | TEXT | 需求单位 |
| `task_name` | TEXT | 采购任务名称 |

#### `order_details` (明细表)
| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `id` | INTEGER (PK) | 自增主键 |
| `order_number` | TEXT (FK) | 关联主单 |
| `detail_no` | TEXT | 明细编号 (如 2601MPB-1) |
| `item_name` | TEXT | 标的名称 |
| `spec_model` | TEXT | 规格型号 |
| `purchase_qty` | TEXT | 采购数量 |
| `plan_release` | TEXT | 计划发放人 |

#### `monthly_plans` (月度计划表)
| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| `id` | INTEGER (PK) | 自增主键 |
| `plan_month` | TEXT | 计划月份 |
| `item_name` | TEXT | 标的名称 |
| `plan_qty` | REAL | 计划数量 |

---

## 7. 附录

### 7.1 术语表
*   **MP**: 民品 (Civil Product)
*   **MPJ**: 机加件 (Machined Part)
*   **MPB**: 半成品 (Semi-finished Product)
*   **PRD**: 产品需求文档 (Product Requirements Document)

### 7.2 参考资料
*   项目规则文件：`.trae/project-rules.md`
*   UI设计原型：`ui/*.py`
